name: Filter Subscription Links

on:
  push:
分支:
      - main
  schedule:
    - cron: '0 0 * * *'  # 每天自动运行一次

jobs:
  filter_links:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3
      
      # Step 2: Download the Clash and V2Ray subscription files
      - name: Download Clash subscription
        run: |
          wget https://api-suc.0z.gs/sub?target=clash&url=https%3A%2F%2Fproxy.v2gh.com%2Fhttps%3A%2F%2Fraw.githubusercontent.com%2FPawdroid%2FFree-servers%2Fmain%2Fsub -O clash.yaml
          
      - name: Download V2Ray subscription
        run: |
          wget https://api-suc.0z.gs/sub?target=v2ray&url=https%3A%2F%2Fproxy.v2gh.com%2Fhttps%3A%2F%2Fraw.githubusercontent.com%2FPawdroid%2FFree-servers%2Fmain%2Fsub -O v2ray.txt
      
      # Step 3: Filter the valid links from the downloaded subscription files
      - name: Filter valid Clash links
        run: |
          grep -Eo 'http[s]?://[^ ]+' clash.yaml | while read -r url; do
            if curl --head --silent --fail "$url" > /dev/null; then
              echo "$url" >> valid_clash_urls.txt
            else
              echo "Invalid: $url"
            fi
          done

      - name: Filter valid V2Ray links
        run: |
          grep -Eo 'http[s]?://[^ ]+' v2ray.txt | while read -r url; do
            if curl --head --silent --fail "$url" > /dev/null; then
              echo "$url" >> valid_v2ray_urls.txt
            else
              echo "Invalid: $url"
            fi
          done

      # Step 4: Commit the filtered files to the repository
      - name: Commit filtered URLs
        run: |
          echo "Updating the filtered configuration files"
          mv valid_clash_urls.txt clash.yaml
          mv valid_v2ray_urls.txt v2ray.txt
          git add clash.yaml v2ray.txt
          git commit -m "Updated subscription files with valid links only"
          git push
